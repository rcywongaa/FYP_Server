import java.awt.FlowLayout;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

import javax.swing.JFrame;
 
public class MainActivity 
{
	public static final int SENSORCOUNT = 5;
	static SerialReader reader;
	static Renderer renderer;
	static Keyboard keyboard;
	static KeyboardView keyboardView;
	final static ScheduledExecutorService scheduler = Executors.newScheduledThreadPool(1);
    public static void main(String[] args) 
    {
    	reader = new SerialReader();
    	renderer = new Renderer();
    	keyboard = new Keyboard();
    	keyboardView = new KeyboardView();
    	 
        JFrame handFrame = new JFrame( "Hand Model" );
        handFrame.getContentPane().add( renderer.getCanvas());
        handFrame.setSize( handFrame.getContentPane().getPreferredSize() );
        handFrame.addWindowListener(new WindowAdapter() {
            public void windowClosing(WindowEvent ev) {
            	reader.close();
                System.exit(0);
            }
        });
        handFrame.setVisible( true );

        JFrame keyboardFrame = new JFrame("Keyboard View");
		keyboardFrame.setContentPane(keyboardView);
		keyboardFrame.setSize(keyboardFrame.getContentPane().getPreferredSize());
		keyboardFrame.pack();
        keyboardFrame.addWindowListener(new WindowAdapter() {
            public void windowClosing(WindowEvent ev) {
                System.exit(0);
            }
        });
        keyboardFrame.setResizable(false);
        keyboardFrame.setVisible(true);
        
        reader.initialize();
        
        scheduleReader();
        
    }
    
    public static void scheduleReader() {
    	final Runnable readRunner = new Runnable(){
    		public void run(){
    			if (reader.isReady()){
    				float[] data = reader.read();
    				if (renderer.getHand().isInit() == false){
    					System.out.println("Initializing J Position");
    					renderer.getHand().initRadAngles(Hand.Side.RIGHT, data);
    				}
    				else {
    					renderer.getHand().setRadAngles(data);
    					if (keyboard.isInit() == false){
    						keyboard.initJPos(renderer.getHand().getXYCoord(Hand.INDEX));
    					}
    					else {
    						keyboard.getKey(renderer.getHand().getXYCoord(Hand.INDEX));
    					}
    				}
    			}
    			//System.out.println("Periodic Event");
    		}
    	};
    	scheduler.scheduleAtFixedRate(readRunner, 1000, 1, TimeUnit.MILLISECONDS);
    }
    
    /*
     * Probably not a good idea to send raw data (3 Axis * 3 Sensors * FINGERNO * sizeof(float))
    public static float[] calcAngles(float[] input){
    	float[] angles = new float[3];
    	angles[0] = 0.0f;
    	angles[1] = (float) Math.atan(-input[0] / ((-input[1])*Math.sin(angles[0]) + (-input[2])*Math.cos(angles[0])));
    	angles[2] = (float) Math.atan2((-input[5]*Math.sin(angles[0]) - (-input[4])*Math.cos(angles[0])), 
    			(input[3]*Math.cos(angles[1]) + (-input[4])*Math.sin(angles[1])*Math.sin(angles[0]) + (-input[5])*Math.sin(angles[1])*Math.cos(angles[0])));
    	return angles;
    }
    */
}